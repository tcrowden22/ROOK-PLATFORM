services:
  postgres:
    image: docker.io/library/postgres:16-alpine
    container_name: rook-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${PG_DB:-rook}
      POSTGRES_USER: ${PG_SUPERUSER:-postgres}
      POSTGRES_PASSWORD: ${PG_SUPERPASS:-changeme}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    expose:
      - "5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_SUPERUSER:-postgres} -d ${PG_DB:-rook}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - rook-internal

  pgadmin:
    image: docker.io/dpage/pgadmin4:latest
    container_name: rook-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "${PGADMIN_PORT:-19090}:80"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rook-internal
    profiles:
      - tools

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: rook-keycloak
    restart: unless-stopped
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${PG_DB:-rook}
      KC_DB_USERNAME: ${PG_SUPERUSER:-postgres}
      KC_DB_PASSWORD: ${PG_SUPERPASS:-changeme}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      KC_PROXY: edge
      KC_HOSTNAME: ${KEYCLOAK_EXTERNAL_HOSTNAME:-192.168.7.116:9000}
      KC_HTTP_RELATIVE_PATH: /auth
      KC_HOSTNAME_ADMIN_URL: ${KEYCLOAK_ADMIN_URL:-http://192.168.7.116:9002/auth}
      KC_HOSTNAME_STRICT_BACKCHANNEL: "false"
    expose:
      - "8080"
    ports:
      - "${KEYCLOAK_PORT:-9002}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rook-internal

  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: rook-api
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_RUNTIME_URL: postgresql://${PG_RUNTIME_USER:-rook_runtime}:${PG_RUNTIME_PASS:-changeme_runtime_password}@postgres:5432/${PG_DB:-rook}
      DATABASE_MIGRATE_URL: postgresql://${PG_MIGRATE_USER:-rook_migrate}:${PG_MIGRATE_PASS:-changeme_migrate_password}@postgres:5432/${PG_DB:-rook}
      DATABASE_URL: postgresql://${PG_APP_USER:-rook_app}:${PG_APP_PASS:-changeme_app_password}@postgres:5432/${PG_DB:-rook}
      API_PORT: ${API_PORT:-3000}
      API_HOST: 0.0.0.0
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://keycloak:8080/auth}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-rook}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-rook-app}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://192.168.7.116:9001}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3000"
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - rook-internal
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: ["node", "dist/index.js"]

  gateway:
    build:
      context: ./apps/gateway
      dockerfile: Dockerfile
    container_name: rook-gateway
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_RUNTIME_URL: postgresql://${PG_RUNTIME_USER:-rook_runtime}:${PG_RUNTIME_PASS:-changeme_runtime_password}@postgres:5432/${PG_DB:-rook}
      DATABASE_URL: postgresql://${PG_APP_USER:-rook_app}:${PG_APP_PASS:-changeme_app_password}@postgres:5432/${PG_DB:-rook}
      GATEWAY_PORT: ${GATEWAY_PORT:-35000}
      GATEWAY_HOST: 0.0.0.0
      API_KEY_SECRET: ${API_KEY_SECRET:-dev-gateway-secret-key-min-32-chars-for-testing-only}
      CORS_ORIGIN: ${GATEWAY_CORS_ORIGIN:-http://192.168.7.116:9001}
      RATE_LIMIT_MAX: ${GATEWAY_RATE_LIMIT_MAX:-1000}
      RATE_LIMIT_WINDOW: ${GATEWAY_RATE_LIMIT_WINDOW:-60000}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "35000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rook-internal
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:35000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: ["node", "dist/index.js"]

  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
    container_name: rook-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-9001}:80"
    depends_on:
      api:
        condition: service_healthy
      kong:
        condition: service_healthy
    networks:
      - rook-internal
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  kong-migrations:
    image: docker.io/library/kong:3.5
    container_name: rook-kong-migrations
    restart: "no"
    profiles:
      - init
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: postgres
      KONG_PG_PORT: 5432
      KONG_PG_USER: ${PG_SUPERUSER:-postgres}
      KONG_PG_PASSWORD: ${PG_SUPERPASS:-changeme}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong}
    command: kong migrations bootstrap
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rook-internal

  kong:
    image: docker.io/library/kong:3.5
    container_name: rook-kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: postgres
      KONG_PG_PORT: 5432
      KONG_PG_USER: ${PG_SUPERUSER:-postgres}
      KONG_PG_PASSWORD: ${PG_SUPERPASS:-changeme}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong}
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_NGINX_WORKER_PROCESSES: "1"
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl
      KONG_ADMIN_GUI_LISTEN: "off"
      KONG_PLUGINS: bundled,key-auth,prometheus
      KONG_LOG_LEVEL: ${LOG_LEVEL:-info}
      KONG_NGINX_DAEMON: "off"
      KONG_OIDC_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-rook-app}
      KONG_OIDC_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
      KONG_SESSION_SECRET: ${KONG_SESSION_SECRET:-changeme-session-secret-min-32-chars-for-testing-only}
    ports:
      - "${KONG_PROXY_PORT:-9000}:8000"
      - "${KONG_PROXY_SSL_PORT:-9444}:8443"
    expose:
      - "8001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rook-internal
    healthcheck:
      test: ["CMD-SHELL", "kong health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  kong-setup:
    image: docker.io/curlimages/curl:latest
    container_name: rook-kong-setup
    restart: "no"
    profiles:
      - init
    depends_on:
      kong:
        condition: service_healthy
    networks:
      - rook-internal
    command: >
      sh -c "
      echo 'Waiting for Kong Admin API...' &&
      until curl -f http://kong:8001/status > /dev/null 2>&1; do sleep 2; done &&
      echo 'Setting up Kong services and routes...' &&
      curl -s -X POST http://kong:8001/services -d 'name=api-service' -d 'url=http://api:3000' > /dev/null &&
      curl -s -X POST http://kong:8001/services -d 'name=gateway-service' -d 'url=http://gateway:35000' > /dev/null &&
      curl -s -X POST http://kong:8001/services -d 'name=frontend-service' -d 'url=http://frontend:80' > /dev/null &&
      curl -s -X POST http://kong:8001/services -d 'name=keycloak-service' -d 'url=http://keycloak:8080' > /dev/null &&
      API_ID=$$(curl -s http://kong:8001/services/api-service | grep -o '\"id\":\"[^\"]*' | head -1 | cut -d'\"' -f4) &&
      GATEWAY_ID=$$(curl -s http://kong:8001/services/gateway-service | grep -o '\"id\":\"[^\"]*' | head -1 | cut -d'\"' -f4) &&
      FRONTEND_ID=$$(curl -s http://kong:8001/services/frontend-service | grep -o '\"id\":\"[^\"]*' | head -1 | cut -d'\"' -f4) &&
      KEYCLOAK_ID=$$(curl -s http://kong:8001/services/keycloak-service | grep -o '\"id\":\"[^\"]*' | head -1 | cut -d'\"' -f4) &&
      curl -s -X DELETE http://kong:8001/routes/api-route > /dev/null 2>&1 || true &&
      curl -s -X POST http://kong:8001/routes -d 'name=api-route' -d 'paths[]=/api' -d 'strip_path=false' -d \"service.id=$$API_ID\" > /dev/null &&
      curl -s -X POST http://kong:8001/routes -d 'name=agents-route' -d 'paths[]=/agents' -d \"service.id=$$GATEWAY_ID\" > /dev/null &&
      curl -s -X POST http://kong:8001/routes -d 'name=frontend-route' -d 'paths[]=/' -d \"service.id=$$FRONTEND_ID\" > /dev/null &&
      curl -s -X POST http://kong:8001/routes -d 'name=keycloak-route' -d 'paths[]=/auth' -d 'strip_path=false' -d \"service.id=$$KEYCLOAK_ID\" > /dev/null &&
      curl -s -X POST http://kong:8001/plugins -d 'name=prometheus' -d 'config.per_consumer=false' > /dev/null &&
      echo 'Kong setup complete!'
      "

volumes:
  postgres_data:
    driver: local

networks:
  rook-internal:
    driver: bridge

