_format_version: "3.0"
_transform: true

services:
  - name: api-service
    url: http://api:3000
    protocol: http
    host: api
    port: 3000
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000

  - name: gateway-service
    url: http://gateway:35000
    protocol: http
    host: gateway
    port: 35000
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000

  - name: frontend-service
    url: http://frontend:80
    protocol: http
    host: frontend
    port: 80
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000

routes:
  - name: api-route
    service: api-service
    paths:
      - /api
    strip_path: false
    preserve_host: false

  - name: agents-route
    service: gateway-service
    paths:
      - /agents
    strip_path: false
    preserve_host: false

  - name: frontend-route
    service: frontend-service
    paths:
      - /
    strip_path: false
    preserve_host: false

plugins:
  # Prometheus metrics (global)
  - name: prometheus
    enabled: true
    config:
      per_consumer: false
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  # OIDC plugin disabled - requires separate installation
  # For now, authentication is handled by API service directly
  # To enable OIDC: Install kong-oidc plugin or use Kong Enterprise

  # Key-auth plugin for agent routes
  - name: key-auth
    service: gateway-service
    route: agents-route
    enabled: true
    config:
      key_names:
        - apikey
        - X-API-Key
      key_in_body: false
      key_in_header: true
      key_in_query: true
      hide_credentials: false
      anonymous: ""

  # File log plugin removed - using stdout/stderr logging instead

consumers:
  # Consumers will be created dynamically via Kong Admin API when agents register
  # For now, we'll create them via scripts or Admin API

